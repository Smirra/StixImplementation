using Microsoft.EntityFrameworkCore;
using Vulnerabilities.Api.Data;
using Vulnerabilities.Api.Models;

namespace Vulnerabilities.Api.Repositories;

public class VulnRepo(VulnContext context) : IVulnRepo
{
    private readonly VulnContext _context = context;

    public async Task<IEnumerable<Vulnerability>> GetVulnerabilities()
    {
        return await _context.Vulnerabilities.ToListAsync();
    }

    public async Task<Vulnerability?> GetVulnerability(string id)
    {
        return await _context.Vulnerabilities.FindAsync(id);
    }

    public async Task<Vulnerability> CreateVulnerability(Vulnerability vulnerability)
    {
        _context.Vulnerabilities.Add(vulnerability);
        await _context.SaveChangesAsync();
        return vulnerability;
    }

    public async Task<Vulnerability> UpdateVulnerability(string id, Vulnerability vulnerability)
    {
        _context.Vulnerabilities.Update(vulnerability);
        await _context.SaveChangesAsync();
        return vulnerability;
    }

    public async Task<bool> DeleteVulnerability(string id)
    {
        var vulnerability = await _context.Vulnerabilities.FindAsync(id);
        if (vulnerability == null)
        {
            return false;
        }

        _context.Vulnerabilities.Remove(vulnerability);
        await _context.SaveChangesAsync();
        return true;
    }

    public async Task<bool> VulnerabilityExists(string id)
    {
        return await _context.Vulnerabilities.AnyAsync(e => e.Id == id);
    }

    public async Task<bool> VulnerabilityExists(Vulnerability vulnerability)
    {
        return await _context.Vulnerabilities.AnyAsync(e => e.Id == vulnerability.Id);
    }

    public async Task<bool> VulnerabilityExists(string id, Vulnerability vulnerability)
    {
        return await _context.Vulnerabilities.AnyAsync(e => e.Id == id && e.Id == vulnerability.Id);
    }

    public async Task<bool> VulnerabilityExists(string id, string name)
    {
        return await _context.Vulnerabilities.AnyAsync(e => e.Id == id && e.Name == name);
    }
}

public interface IVulnRepo
{
    Task<IEnumerable<Vulnerability>> GetVulnerabilities();
    Task<Vulnerability?> GetVulnerability(string id);
    Task<Vulnerability> CreateVulnerability(Vulnerability vulnerability);
    Task<Vulnerability> UpdateVulnerability(string id, Vulnerability vulnerability);
    Task<bool> DeleteVulnerability(string id);
    Task<bool> VulnerabilityExists(string id);
    Task<bool> VulnerabilityExists(Vulnerability vulnerability);
    Task<bool> VulnerabilityExists(string id, Vulnerability vulnerability);
    Task<bool> VulnerabilityExists(string id, string name);
}